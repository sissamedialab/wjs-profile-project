.run-tests:
  stage: test
  # FIXME: This must be reverted to develop tag once 1.6.0 MR has been merged
  image: registry.gitlab.sissamedialab.it/wjs/janeway/debian-python-git-janeway:1.6.0-20240623

  # NB: Must match with test_settings.DATABASES
  variables:
    POSTGRES_USER: janeway
    POSTGRES_PASSWORD: janeway
    POSTGRES_DB: janeway
    # used by `pytest ...`:
    DJANGO_SETTINGS_MODULE: core.cicd_test_settings
    # used by `manage.py ...`:
    JANEWAY_SETTINGS_MODULE: core.cicd_settings
    # Use the following after force-pushes:
    GIT_STRATEGY: clone
    # see e.g.:
    # - https://docs.gitlab.com/ee/ci/runners/configure_runners.html#git-strategy
    # - https://stackoverflow.com/a/66519431/1581629
    PYTHONPATH: ${CI_PROJECT_DIR}

  services:
    - name: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/postgres:13.8
      alias: db

  script:
    - cp setup_environment /usr/local/bin/
    - setup_environment
    - cd /janeway/src
    - pytest -c ${CI_PROJECT_DIR}/pytest.ini ${CI_PROJECT_DIR}/ -v -n 4 --reverse -m "not fix_labels" --create-db


# lintme:
#   extends: .run-tests

{% load django_bootstrap5 wjs_permissions wjs_review %}
<div class="accordion-item">
  <h2 class="accordion-header" id="review-{{ version.number }}">
    <button class="accordion-button {% if not version.latest or production %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-review-{{ version.number }}"
            aria-expanded="{% if version.latest %} true{% else %}false{% endif %}" aria-controls="collapse-review-{{ version.numberj }}">
      {% translate "Version" %} {{ version.number }}
    </button>
  </h2>
  <div id="collapse-review-{{ version.number }}" class="accordion-collapse collapse{% if version.latest and not production %} show{% endif %}" aria-labelledby="heading-review-{{ version }}">
    <div class="accordion-body d-flex flex-column gap-4">
      <div class="vstack gap-3">
        <div>
          {% for decision in version.decisions %}
            {% user_has_access_to workflow user decision PermissionType.ALL as all_files %}
            {% user_has_access_to workflow user decision PermissionType.NO_NAMES as no_names %}
            {% if no_names or all_files %}
              {% include "wjs_review/details/elements/review_decision.html" with show_name=all_files %}
            {% endif %}
          {% endfor %}
        </div>
        <div>
          {% for revision in version.revision_requests %}
            {% user_has_access_to workflow user revision PermissionType.ALL as all_files %}
            {% user_has_access_to workflow user revision PermissionType.NO_NAMES as no_names %}
            {% if no_names or all_files %}
              {% include "wjs_review/details/elements/review_revision.html" with article_info=revision %}
            {% endif %}
          {% empty %}
            {% user_has_access_to workflow user workflow PermissionType.ALL as all_files %}
            {% user_has_access_to workflow user workflow PermissionType.NO_NAMES as no_names %}
            {% if no_names or all_files %}
              {% include "wjs_review/details/elements/review_revision.html" with article_info=workflow.article %}
            {% endif %}
          {% endfor %}
        </div>
        {% if version.number == 1 %}
          {% user_has_access_to workflow user workflow BinaryPermissionType.ALL secondary_permission=True as all_files %}
          {% if all_files and article.comments_editor %}
            <div>
              {% include "wjs_review/details/elements/review_cover.html" %}
            </div>
          {% endif %}
        {% elif version.main_revision %}
          {% user_has_access_to workflow user version.main_revision BinaryPermissionType.ALL secondary_permission=True as all_files %}
          {% if all_files and version.main_revision.author_note %}
            <div>
              {% include "wjs_review/details/elements/review_cover.html" %}
            </div>
          {% endif %}
        {% endif %}
        {% if workflow|is_user_article_reviewer:request.user or workflow|is_user_article_manager:request.user %}
          <div class="vstack gap-4">
            {% for stage, assignments in version.assignments_by_stage.items %}
              {% include "wjs_review/details/elements/review_assignment_list.html" %}
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

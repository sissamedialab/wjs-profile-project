{% load django_bootstrap5 wjs_articles wjs_review wjs_tags %}
{% article_css_classes workflow as article_classes %}
{% with article=workflow.article attention_flag=workflow|article_requires_attention_tt:user %}
  <tr {% if attention_flag %}class="table-warning fw-bold"{% endif %}>
    <td class="text-nowrap">
      {{ article.journal.code }}
    </td>
    <td>
      {{ article.section.name }}
    </td>
    <td>
      <a href="{% url 'wjs_article_details' workflow.pk %}" class="fw-bold">{{ article.pk }}</a>
    </td>
    <td>
      <span title="Last status change TODO workflow.date_last_transition">{{ workflow.latest_state_change|timesince }} since last state change</span>
    </td>
    <td class="align-bottom position-relative {% if attention_flag %}fw-bolder{% endif %}">
      {% include "wjs_review/lists/elements/table_item_status.html" with publish_status=True %}
    </td>
    <td>
      {{ article.primary_issue|default_if_none:"" }}
    </td>
    <td title="latest personal note">
      {% last_user_note target=workflow.article as note %}
      {% if note %}
        <button type="button" class="btn" data-bs-toggle="modal" data-bs-target="#note_modal">{{ note.body|truncatechars_html:7|striptags }} <i class="bi bi-card-text"></i></button>
        {% include "wjs_review/base/elements/modal.html" with modal_id="note_modal" modal_title="Notes" modal_body_title=note.subject modal_body=note.body %}
      {% endif %}
    </td>
    <td>
      {% if workflow.state == "ReadyForTypesetter" %}
        <form id="{{ action.slug }}" action="{% url 'wjs_typ_take_in_charge' workflow.id %}" method="post">
          {% csrf_token %}
          {% translate "Take in charge" as take_label %}
          {% bootstrap_button button_type="submit" name="take-charge" value=1 content=take_label %}
        </form>
      {% endif %}
    </td>
  </tr>
{% endwith %}

{% load wjs_articles wjs_tags %}
<tr>
  <td>
    {{ issue.display_title }}
  </td>
  <td>
    {{ issue.articles.count }}
  </td>
  <td>
    {{ issue.date|date:DATE_FORMAT }}
  </td>
  {% if request.user|is_user_eo %}
    <td title="latest EO note">
      {% last_eo_note target=issue as note %}
      {% if note %}
        <button type="button" class="btn" data-bs-toggle="modal" data-bs-target="#note_modal">{{ note.body|truncatechars_html:7|striptags }} <i class="bi bi-card-text"></i></button>
        {% include "wjs_review/base/elements/modal.html" with modal_id="note_modal" modal_title="Notes" modal_body_title=note.subject modal_body=note.body %}
      {% endif %}
      <a href="#"><i class="bi bi-pencil"></i></a>
    </td>
  {% else %}
    <td title="latest personal note">
      {% last_user_note target=issue as note %}
      {% if note %}
        <button type="button" class="btn" data-bs-toggle="modal" data-bs-target="#note_modal">{{ note.body|truncatechars_html:7|striptags }} <i class="bi bi-card-text"></i></button>
        {% include "wjs_review/base/elements/modal.html" with modal_id="note_modal" modal_title="Notes" modal_body_title=note.subject modal_body=note.body %}
      {% endif %}
      <a href="{% url "wjs_message_write" article_id=article.id recipient_id=user.id %}"><i class="bi bi-pencil"></i></a>
    </td>
  {% endif %}
  <td>
    <button class="btn btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#articles-{{ issue.pk }}" aria-expanded="false" aria-controls="articles-{{ issue.pk }}">
      <i class="bi bi-chevron-double-down"></i>
    </button>
  </td>
</tr>
<tr>
  <td colspan="5">
    <div id="issues-list-content">
      {% include "wjs_review/lists/elements/issue/issue_list.html" %}
    </div>
  </td>
</tr>
{% block js %}
  <!-- jsDelivr :: Sortable :: Latest (https://www.jsdelivr.com/package/npm/sortablejs) -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  <script>
    htmx.onLoad(function(content) {
      const sortables = content.querySelectorAll(".sortable");
      for (let i = 0; i < sortables.length; i++) {
        let sortable = sortables[i];
        let sortableInstance = new Sortable(sortable, {
          animation: 150,
          ghostClass: "blue-background-class",
          handle: ".sort-grip",
          draggable: ".article",
          // Make the `.htmx-indicator` unsortable
          filter: ".htmx-indicator",
          onMove: function(evt) {
            return evt.related.className.indexOf("htmx-indicator") === -1;
          },

          // Disable sorting on the `end` event
          onEnd: function(evt) {
            this.option("disabled", true);
          },
        });

        // Re-enable sorting on the `htmx:afterSwap` event
        sortableInstance.el.parentElement.parentElement.addEventListener("htmx:afterSwap", function() {
          sortableInstance.option("disabled", false);
        });
      }
    });
    document.body.addEventListener("htmx:beforeSwap", function(evt) {
      try {
        const response = JSON.parse(evt.detail.serverResponse);
        if (response.status === "okay") {
          evt.target.classList.remove("d-none");
          evt.target.classList.add("bg-danger");
        }
      } catch (e) {
        console.log(e);
      }
    });
  </script>
{% endblock js %}

{% load wjs_review %}
<div class="card border border-2">
    <div class="card-body">
        {% with article=workflow.article %}
            <div>
                <!-- article id, type, title -->
                <p>
                    {{ article.section.name }} â€” {{ article.id }}
                    <a title="Paper's details"
                       href="{% url 'wjs_article_details' workflow.id %}"
                       class="btn btn-primary text-white fw-bold">{{ article.title|truncatewords:5 }}</a>
                </p>
                <p>
                    by
                    {% for author in article.authors.all %}
                        {% if author == article.correspondence_author %}
                            <span class="fst-italic" title="Corresponding / correspondence author">{{ author }},</span>
                        {% else %}
                            <span>{{ author }},</span>
                        {% endif %}
                    {% endfor %}
                </p>
                <p>
                    In special Issue TODO: merge Janeway collections and WJS special-issues <a href="https://github.com/BirkbeckCTP/janeway/issues/785">janeway#785</a> â€”
                    {{ article.primary_issue }}
                </p>
                <p>Current state: "{{ workflow.get_state_display }}" (last modified {{ workflow.modified }})</p>
                <p>
                    Reviewers ({{ workflow.article.reviewassignment_set.count }}):
                    {% for assignment in workflow.article.reviewassignment_set.all %}
                        {% if assignment.date_accepted %}
                          {% if assignment.is_complete %}
                            <a href="{% url "wjs_review_end" assignment_id=assignment.pk %}?access_code={{ assignment.access_code }}">{{ assignment.reviewer }}</a>
                          {% else %}
                            <a href="{% url "wjs_review_review" assignment_id=assignment.pk %}?access_code={{ assignment.access_code }}">{{ assignment.reviewer }}</a>
                          {% endif %}
                        {% elif assignment.date_declined %}
                            <a href="{% url "wjs_declined_review" assignment_id=assignment.pk %}?access_code={{ assignment.access_code }}">{{ assignment.reviewer }}</a>
                        {% else %}
                            <a href="{% url "wjs_evaluate_review" assignment_id=assignment.pk %}?access_code={{ assignment.access_code }}">{{ assignment.reviewer }}</a>
                        {% endif %}
                    {% endfor %}
                </p>
                <p>
                    State-dependent info <strong>and</strong> To-do flag TODO:
                    collect this knowledge into <code>wjs_review.logic</code> (one class per state âœ• viewing role) and
                    highlight (ðŸ’¡) the entry if the editor is expected to act.
                    <a data-bs-toggle="collapse"
                       href="#collapseExamples"
                       role="button"
                       aria-expanded="false"
                       aria-controls="collapseExamples">Examples...</a>
                </p>
                <p>
                    Last action + related info TODO: maybe from <a href="https://github.com/BirkbeckCTP/janeway/blob/2fb70af7d19516df3136cafeb0f99516a566cb8b/src/utils/models.py#L47">utils.models.LogEntry</a>
                    {{ article|get_article_log_entries }}
                </p>
                <div class="collapse" id="collapseExamples">
                    <div class="card card-body">
                        <ol>
                            <li>assigned to reviewer x + deadline for rev's action</li>
                            <li>assigned to reviewer y + status [report sent];</li>
                            <li>major/minor revision requested+ deadline; active_revision_requests: {{ article.active_revision_requests }}</li>
                            <li>
                                final decision + date <strong>Warning:</strong> a final decision should move the paper away from this list
                            </li>
                            <li>
                                ðŸ’¡ message by EO: se l'EO segnala un certo paper all'editor per qualche motivo particolare (<em>see below</em>)
                            </li>
                            <li>
                                ðŸ’¡ new message to read - messages must have a "<code>read</code>" flag (â˜¡ UX mess?). TODO: details for comunications in <a href="https://gitlab.sissamedialab.it/wjs/specs/-/issues/429">specs#429</a>; will probably create a new model based on <a href="https://github.com/BirkbeckCTP/janeway/blob/2fb70af7d19516df3136cafeb0f99516a566cb8b/src/utils/models.py#L47">LogEntry</a>
                            </li>
                            <li>ðŸ’¡ to be assigned to reviewer + deadline</li>
                            <li>ðŸ’¡ to be reviewed + deadline</li>
                            <li>ðŸ’¡ Report(s) received + date of last report</li>
                            <li>ðŸ’¡ major/minor revision to handle + deadline</li>
                            <li>ðŸ’¡ appeal to be handled + deadline</li>
                        </ol>
                    </div>
                </div>
                <p>
                    Last editor's note TODO: add a model similar to <a href="https://github.com/BirkbeckCTP/janeway/blob/2fb70af7d19516df3136cafeb0f99516a566cb8b/src/submission/models.py#L2112"><strong>submission.Note</strong></a>
                </p>
                <div class="card border border-1">
                    <div class="card-head">Actions</div>
                    <div class="card-body">
                        {% get_available_transitions workflow as transitions %}
                        <form method="post" action="{% url "update_state" workflow.pk %}">
                            <input type="hidden" name="state" value="{{ workflow.state }}">
                            {% csrf_token %}
                            {% for transition in transitions %}
                                {% if transition.name != "editor_writes_editor_report" %}
                                    <button type="submit" name="action" value="{{ transition.name }}">{{ transition.name }}</button>
                                {% endif %}
                                {% if transition.name == "editor_writes_editor_report" %}
                                    <a href="{% url 'wjs_select_reviewer' workflow.pk %}">Select reviewer</a>
                                {% endif %}
                            {% endfor %}
                        </form>
                    </div>
                {% endwith %}
            </div>
        </div>
    </div>
</div>

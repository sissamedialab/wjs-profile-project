{% load django_bootstrap5 i18n wjs_permissions wjs_review %}
<div class="card border border-1">
    {% with assignment=assignment_and_actions.assignment %}
        {% with attention_flag=assignment|assignment_requires_attention_tt:user %}
          {% url "wjs_assign_permission" pk=workflow.pk user_id=assignment.reviewer.id as revision_permission_url %}
          {% user_can_set_permission workflow=workflow user=request.user as can_set_permission %}
    <div class="card-body">
        {% if assignment.date_declined %}
        <p class="text-muted">Declined assignment</p>
        {% else %}
                {% if attention_flag %}<p class="text-warning">{{ attention_flag }}</p>{% endif %}
        {% endif %}
                <p>
                    Assignment {{ assignment.id }} to
                    {% if assignment.is_complete and assignment.decistion == "withdrawn" %}
                        <a href="{% url "wjs_review_end" assignment_id=assignment.pk %}?access_code={{ assignment.access_code }}">{{ assignment.reviewer }}</a>
                    {% elif assignment.date_accepted and assignment.is_complete %}
                        <a href="{% url "wjs_review_end" assignment_id=assignment.pk %}?access_code={{ assignment.access_code }}">{{ assignment.reviewer }}</a>
                    {% elif assignment.date_accepted %}
                        <a href="{% url "wjs_review_review" assignment_id=assignment.pk %}?access_code={{ assignment.access_code }}">{{ assignment.reviewer }}</a>
                    {% elif assignment.date_declined %}
                        <a href="{% url "wjs_declined_review" assignment_id=assignment.pk %}?access_code={{ assignment.access_code }}">{{ assignment.reviewer }}</a>
                    {% else %}
                        <a href="{% url "wjs_evaluate_review" assignment_id=assignment.pk %}?access_code={{ assignment.access_code }}">{{ assignment.reviewer }}</a>
                        {% endif %}
                        <a href="{% url "wjs_message_write" article_id=assignment.article.id recipient_id=assignment.reviewer.id %}" title="Click to contact / communicate">üìß</a>{# TODO: add id of reviewer #}
                        {% if can_set_permission %}
                          <a href="{{ revision_permission_url }}" title="Edit permissions">üóù</a>
                        {% endif %}
                    (requested {{ assignment.date_requested }}) for review round {{ assignment.review_round.round_number }}.
                </p>
                <p>
                    {% if assignment.is_complete %}
                        {% if assignment.decision == "withdrawn" %}
                            <span class="text-muted">Widthdrawn</span> on {{ assignment.date_complete }}.
                        {% elif assignment.date_accepted %}
                            <span class="text-success">Completed</span> on {{ assignment.date_complete }}.
                        {% elif assignment.date_declined %}
                            <span class="text-muted">declined</span> {{ assignment.date_declined }}.
                        {% endif %}
                    {% else %}
                        Due
                        {{ assignment.date_due }} and
                        {% if assignment.date_accepted %}
                            <span class="text-warning">accepted</span>
                            {{ assignment.date_accepted }}
                        {% else %}
                            <span class="text-warning">waiting for answer.</span>
                        {% endif %}
                    {% endif %}
                </p>
                {% if assignment.date_reminded %}
                    <p>
                        Last reminder sent on
                        {{ assignment.date_reminded }}
                    </p>
                {% endif %}
            </div>
        {% endwith %}
    <div>
        {% for answer in assignment.reviewassignmentanswer_set.all %}
            field:{{ answer.best_label }}, answer: {{ answer.answer }}
        {% endfor %}
    </div>
    {% endwith %}
    <div>
        {% for action in assignment_and_actions.actions %}
            <a class="btn {% if action.url == '#' %}btn-secondary{% else %}btn-primary{% endif %}"
               href="{{ action.url }}"
               {% if action.tooltip %}title="{{ action.tooltip }}"{% endif %}>
                {% if action.label %}
                    {{ action.label }}
                {% else %}
                    {{ action.name }}
                {% endif %}
            </a>
        {% endfor %}
    </div>
</div>

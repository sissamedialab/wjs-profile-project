{% load settings %}
{% setting_var request.journal 'use_crossref' as use_crossref %}

<div class="card my-4">
    <div class="card-body">
        <h3 class="card-title">Editors</h3>
        <table class="table">
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Type</th>
            </tr>
            {% for assignment in article.editors %}
                <tr>
                    <td>{{ assignment.editor.full_name }}</td>
                    <td><a
                        href="mailto:{{ assignment.editor.email }}">{{ assignment.editor.email }}</a>
                    </td>
                    <td>{{ assignment.editor_type|capfirst }}</td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="3">No users assigned</td>
                </tr>
            {% endfor %}
        </table>
    </div>
</div>
<div class="card my-4">
    <div class="card-body">
        <h3 class="card-title">Review status</h3>
        <table class="table">
            <tr>
                <td colspan="4">{{ article.articleworkflow.get_state_display }}</td>
            </tr>
            <tr>
                <td colspan="4">
                    This article has {{ article.completed_reviews.count }}
                    completed reviews.
                </td>
            </tr>
            <tr>
                <td colspan="4">
                    {% if article.peer_reviewed %}
                        This article has been marked as peer reviewed.
                    {% elif not article.is_accepted and article.completed_reviews %}
                        If this article is accepted, it will be marked as peer
                        reviewed.
                    {% else %}
                        This article has not been marked as peer reviewed.
                    {% endif %}
                </td>
            </tr>
        </table>
    </div>
</div>
{% if article.projected_issue %}
    <div class="card my-4">
        <div class="card-body">
            <h3 class="card-title">Projected Issue</h3>
            <table class="table">
                <tr>
                    <th>Issue ID</th>
                    <th>Issue Title</th>
                    <th>Volume</th>
                    <th>Number</th>
                    <th>Published</th>
                    <th></th>
                </tr>
                {% if article.projected_issue %}
                    <tr>
                        <td>{{ article.projected_issue.id }}</td>
                        <td>{{ article.projected_issue.issue_title }}</td>
                        <td>{{ article.projected_issue.volume }}</td>
                        <td>{{ article.projected_issue.issue }}</td>
                        <td>{{ article.projected_issue.date }}</td>
                        <td><a
                            href="{% url 'manage_issues_id' article.projected_issue.pk %}">Issue
                            Manager</a></td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="6">This article does not have a projected
                            issue.
                            {% if user_is_editor or request.user.is_staff %} You
                                can
                                <a href="{% url 'review_projected_issue' article.pk %}?return={{ request.path|urlencode }}">assign
                                    one</a>.{% endif %}</td>
                    </tr>
                {% endif %}
            </table>
        </div>
    </div>
{% endif %}

<div class="card my-4">
    <div class="card-body">
        <h3 class="card-title">Identifiers</h3>
        {% if user_is_editor or user_is_production or user_is_section_editor %}
            <a class="button" href="{% url 'edit_identifiers' article.pk %}"
               target="_blank">>Edit</a>
        {% endif %}
        <table class="table">
            <tr>
                <th>ID Type</th>
                <th>Identifier</th>
                <th>Status</th>
            </tr>
            <tr>
                <td>ID</td>
                <td>{{ article.pk }}</td>
                <td>Assigned</td>
            </tr>
            {% if use_crossref %}
                <tr>
                    {% with article.get_doi as doi %}
                        {% if doi %}
                            <td>DOI</td>
                            <td>{{ doi }}</td>
                            <td>
                                {% for identifier in article.identifiers %}
                                    {% if identifier.identifier == doi %}
                                        {% if identifier.deposit %}
                                            <a href="{% url "poll_doi_output" article.pk identifier.pk %}">
                                                {% if identifier.deposit.success %}
                                                    <i class="fa fa-check">&nbsp;</i>
                                                {% else %}
                                                    <i class="fa fa-exclamation-circle">&nbsp;</i>
                                                {% endif %}
                                            </a>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            </td>
                        {% else %}
                            <td>DOI</td>
                            <td>Article has no DOI</td>
                            <td>
                                {% if user_is_editor or user_is_production or user_is_section_editor %}
                                    <a href="{% url "add_new_identifier" article.pk %}"
                                       class="btn btn-secondary">Add DOI</a>
                                {% endif %}
                            </td>
                        {% endif %}
                    {% endwith %}
                </tr>
            {% endif %}
        </table>
    </div>
</div>

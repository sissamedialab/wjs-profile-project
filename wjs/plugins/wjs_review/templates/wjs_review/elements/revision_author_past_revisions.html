{% load files %}
{% if revisions.exists %}
<div class="card my-4">
    <div class="card-body">
        <h3 class="card-title">Past versions</h3>

        <div class="accordion" id="accordionRevision">
            {% for revision in revisions %}
                <div class="accordion-item">
                    <h5 class="accordion-header" id="headingOne">
                      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRevision{{ revision.review_round.round_number }}" aria-expanded="true" aria-controls="collapseRevision{{ revision.review_round.round_number }}">
                        Version: {{ revision.review_round.round_number }}
                      </button>
                    </h5>
                    {% comment %}
                        this is a rather convoluted way to add the review round suffix to the modal id as round_number is an int and we can't use add with string + int
                        so we must first convert revision.review_round.round_number to a string using stringfilter in a wrapping with templatetag
                        because we can't concatenate filters to modify a filter argument, it only works to modify the filters *output*
                    {% endcomment %}
                    {% with round_str=revision.review_round.round_number|stringformat:"s" %}
                        <div id="collapseRevision{{ round_str }}" class="accordion-collapse collapse">
                            <div class="accordion-body">
                            <h6>Version files</h6>
                            <table class="small scroll">
                                {% if revision.manuscript_files.exists %}
                                    <tr>
                                        <th>Manuscript files</th>
                                        <th>
                                            {% url 'revisions_use_files' revision_request.article.pk revision_request.pk "manuscript" as manuscript_url %}
                                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#manuscriptModal{{ round_str }}">
                                              Use this version
                                            </button>
                                            {% include "elements/modal.html" with id="manuscriptModal"|add:round_str url=manuscript_url cta="Confirm replace" title="Replace files" body="Replace files with selected version" %}
                                        </th>
                                    </tr>
                                    <tr>
                                        <th>Label</th>
                                        <th>Filename</th>
                                        <th>Uploaded</th>
                                        <th>Size</th>
                                        <th>Download</th>
                                    </tr>
                                    {% for file in revision.manuscript_files.all %}
                                    <tr>
                                        <td>{{ file.label }}</td>
                                        <td>{{ file.original_filename }}</td>
                                        <td>{{ file.date_uploaded|date:"Y-m-d G:i" }}</td>
                                        <td>{% file_size file article %}</td>
                                        <td><a href="?file_id={{ file.id }}">↓</a></td>
                                    </tr>
                                    {% endfor %}
                                {% endif %}
                                {% if revision.data_figure_files.exists %}
                                    <tr>
                                        <th>Figure files</th>
                                        <th>
                                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#figureModal{{ round_str }}">
                                              Use this version
                                            </button>
                                            {% include "elements/modal.html" with id="figureModal"|add:round_str url=manuscript_url cta="Confirm replace" title="Replace files" body="Replace files with selected version" %}
                                        </th>
                                    </tr>
                                    <tr>
                                        <th>Label</th>
                                        <th>Filename</th>
                                        <th>Uploaded</th>
                                        <th>Size</th>
                                        <th>Download</th>
                                    </tr>
                                    {% for file in revision.data_figure_files.all %}
                                    <tr>
                                        <td>{{ file.label }}</td>
                                        <td>{{ file.original_filename }}</td>
                                        <td>{{ file.date_uploaded|date:"Y-m-d G:i" }}</td>
                                        <td>{% file_size file article %}</td>
                                        <td><a href="?file_id={{ file.id }}">↓</a></td>
                                    </tr>
                                    {% endfor %}
                                {% endif %}
                                {% if revision.supplementary_files.exists %}
                                    <tr>
                                        <th>Supplementary files</th>
                                        <th>
                                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#supplementaryModal{{ round_str }}">
                                              Use this version
                                            </button>
                                            {% include "elements/modal.html" with id="supplementaryModal"|add:round_str url=manuscript_url cta="Confirm replace" title="Replace files" body="Replace files with selected version" %}
                                        </th>
                                    </tr>
                                    <tr>
                                        <th>Label</th>
                                        <th>Filename</th>
                                        <th>Uploaded</th>
                                        <th>Size</th>
                                        <th>Download</th>
                                    </tr>
                                    {% for file in revision.supplementary_files.all %}
                                    <tr>
                                        <td>{{ file.label }}</td>
                                        <td>{{ file.original_filename }}</td>
                                        <td>{{ file.date_uploaded|date:"Y-m-d G:i" }}</td>
                                        <td>{% file_size file article %}</td>
                                        <td><a href="?file_id={{ file.id }}">↓</a></td>
                                    </tr>
                                    {% endfor %}
                                {% endif %}
                            </table>
                            </div>
                        </div>
                    {% endwith %}
                </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}
